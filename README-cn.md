# Repeater 复读机
📼 基于浏览器事件录制的视觉测试工具。


## 介绍
测试大型 Web 项目时有这些痛点：

* 难以编写复杂交互的测试用例。
* 难以为遗留代码添加测试支持。
* 难以保证最终界面的正确渲染。

但是，人肉的自测一直非常容易，我们能直接自动化这个流程吗？不妨设想这样的工作流：

1. 手工操作你的应用，自动记录鼠标、键盘等交互事件流。
2. 为最终 UI 界面截图，作为测试用例。
3. 使用无头浏览器回放录制的事件，通过截图比对，判断用例是否通过。

基于这个想法，我们发明了 Repeater（复读机），为你提供全新的测试手段。核心特性：

* 无侵入性的浏览器事件录制，附带可定制的事件流过滤支持。
* 像素级的视觉回归测试，支持批处理。图片比完整 DOM 快照更可读，体积更小！
* 真正开箱即用。我们默认复用你的系统上现成的 Chrome 作为宿主环境，无原生依赖，无二进制包。
* 面向持续集成，支持可配置的资源池机制以便在 CI 环境中使用。


## 使用
由 NPM 安装：

``` bash
npm install repeater.js
```

Repeater 由两部分组成：收集用户事件的 **Recorder** 和回放测试用例的 **Replayer**。它们的使用是互相独立的。

### 记录交互事件
要想在已有的项目中记录事件，只需在项目中其他 JS 代码加载*之前*导入脚本：

``` js
import 'repeater.js'
import 'vue'
// ...
```

页面加载完成后，用户事件将被自动记录。要想结束录制，打开 Chrome 控制台输入 `copyLog()`，将其粘贴为 JSON 格式文件即可。

### 回放与测试
录制了事件日志的 JSON 文件后，你可以使用 Repeater 的命令行来添加截图。

``` bash
npx repeater path/to/log.json --update
```

这会通过 [Puppeteer](https://github.com/GoogleChrome/puppeteer) 回放事件并截图。要想验证某个用例是否通过，只需这条命令：

``` bash
npx repeater path/to/log.json
```

还可以批量运行测试：

``` bash
npx repeater path/to/tests
```

## 最佳实践
一些应用 Repeater 时的实践建议：

* 可以为视觉测试提供单独的「静态」Demo 页，以便保证相同的输入总能渲染出相同的输出。
* 如果多个测试用例需要不同的初始化过程，可以在 Demo 页的 URL 参数中做出一些区分，以便于自动化。**Don't Repeat Yourself.**
* 使用较小的浏览器窗口来截图。窗口越小，截图尺寸显著更小，且图片比对的敏感度更高。


## 注意事项

### 滚动事件
Chrome 对滚动有非常特殊的优化处理，Puppeteer 目前也没有 first-class 的 API 实现该控制。这导致了滚动行为在回放上的困难。

### 外部状态
UI 是充满副作用的。Repeater 只将用户输入事件作为唯一的数据源，因此你需要尽量确保外部状态的稳定。并且，这里也有一些限制。例如：

* 网络状态。一旦 HTTP 请求的响应改变，就可能产生问题。
* 剪贴板状态。从系统剪贴板中的粘贴行为是不可靠的。
* 输入法状态。使用输入法输入的文本可能无法被正确地回放。


## More
更多相关信息，请参阅主线维护的 [README 文档](./README.md)


## License
MIT

Code with ❤️ by Undefined FE team, Gaoding Inc. 2019.
